{
  "hash": "c11aeb1e2b78e5b7b00ea51306ffdba8",
  "result": {
    "engine": "knitr",
    "markdown": "---\nengine: knitr\ntitle: Measuring performance\n---\n\n## Learning objectives:\n\n- Understand how to figure out where R is spending time executing your code\n- Learn about the tools for benchmarking your code\n- Implement code profiling\n\n\n## Introduction\n\n> \"Before you can make your code faster, you first need to figure out what’s making it slow.\"\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![SLOW DOWN TO LEARN HOW TO CODE FASTER | credits: packtpub.com](images/23_code_faster.jpeg){fig-align='center' width=348}\n:::\n:::\n\n\n\n- **profile** your code: measure the run-time of each line of code using realistic inputs\n- **experiment** with alternatives to find faster code\n- **microbenchmark** to measure the difference in performance.\n\n## Packages introduced\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(profvis)\nlibrary(bench)\nlibrary(microbenchmark)\n```\n:::\n\n\n\n## Profiling\n\nProfiling the code is the process of gathering information about the resource\nrequirements of the individual calls in your code.\n\nProfilers sample the code performance by stopping the execution of code \nevery few milliseconds, gauging which process is being engaged, \nand recording the resource utilization.\n\nExample:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nf <- function() {\n  pause(0.1)\n  g()\n  h()\n}\ng <- function() {\n  pause(0.1)\n  h()\n}\nh <- function() {\n  pause(0.1)\n}\n```\n:::\n\n\n## Profiling\n\nProfile the execution of f():\n\n    - `profvis::pause()` is used instead of `Sys.sleep()` \n      as the latter makes R use no resources\n    - profile `f()`, with `utils::Rprof()`\n    \n\n::: {.cell}\n\n```{.r .cell-code}\ntmp <- tempfile()\nRprof(tmp, interval = 0.1)\nf()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> NULL\n```\n\n\n:::\n\n```{.r .cell-code}\nRprof(NULL)\nwriteLines(readLines(tmp))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> sample.interval=100000\n#> \"pause\" \"f\" \"eval\" \"eval\" \"withVisible\" \"withCallingHandlers\" \"eval\" \"eval\" \"with_handlers\" \"doWithOneRestart\" \"withOneRestart\" \"withRestartList\" \"doWithOneRestart\" \"withOneRestart\" \"withRestartList\" \"withRestarts\" \"evaluate::evaluate\" \"evaluate\" \"in_dir\" \"in_input_dir\" \"eng_r\" \"block_exec\" \"call_block\" \"process_group\" \"withCallingHandlers\" \"with_options\" \"xfun:::handle_error\" \"process_file\" \"knitr::knit\" \"rmarkdown::render\" \"execute\" \".main\" \n#> \"pause\" \"g\" \"f\" \"eval\" \"eval\" \"withVisible\" \"withCallingHandlers\" \"eval\" \"eval\" \"with_handlers\" \"doWithOneRestart\" \"withOneRestart\" \"withRestartList\" \"doWithOneRestart\" \"withOneRestart\" \"withRestartList\" \"withRestarts\" \"evaluate::evaluate\" \"evaluate\" \"in_dir\" \"in_input_dir\" \"eng_r\" \"block_exec\" \"call_block\" \"process_group\" \"withCallingHandlers\" \"with_options\" \"xfun:::handle_error\" \"process_file\" \"knitr::knit\" \"rmarkdown::render\" \"execute\" \".main\" \n#> \"pause\" \"h\" \"g\" \"f\" \"eval\" \"eval\" \"withVisible\" \"withCallingHandlers\" \"eval\" \"eval\" \"with_handlers\" \"doWithOneRestart\" \"withOneRestart\" \"withRestartList\" \"doWithOneRestart\" \"withOneRestart\" \"withRestartList\" \"withRestarts\" \"evaluate::evaluate\" \"evaluate\" \"in_dir\" \"in_input_dir\" \"eng_r\" \"block_exec\" \"call_block\" \"process_group\" \"withCallingHandlers\" \"with_options\" \"xfun:::handle_error\" \"process_file\" \"knitr::knit\" \"rmarkdown::render\" \"execute\" \".main\" \n#> \"pause\" \"h\" \"f\" \"eval\" \"eval\" \"withVisible\" \"withCallingHandlers\" \"eval\" \"eval\" \"with_handlers\" \"doWithOneRestart\" \"withOneRestart\" \"withRestartList\" \"doWithOneRestart\" \"withOneRestart\" \"withRestartList\" \"withRestarts\" \"evaluate::evaluate\" \"evaluate\" \"in_dir\" \"in_input_dir\" \"eng_r\" \"block_exec\" \"call_block\" \"process_group\" \"withCallingHandlers\" \"with_options\" \"xfun:::handle_error\" \"process_file\" \"knitr::knit\" \"rmarkdown::render\" \"execute\" \".main\"\n```\n\n\n:::\n:::\n\n    \n    \n## Visualising profiles\n\nMakes easier to build up a mental model of what you need to change:\n\n    - `profvis::profvis(expr)`\n    - `utils::summaryRprof()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(\"scripts/profiling-example.R\")\nprofvis(f())\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"profvis html-widget html-fill-item\" id=\"htmlwidget-eb0f5ebc4195aea60f1d\" style=\"width:100%;height:600px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-eb0f5ebc4195aea60f1d\">{\"x\":{\"message\":{\"prof\":{\"time\":[1,1,1,2,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,9,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,15,15,15,15,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,22,22,22,23,23,23,24,24,24,25,25,25,26,26,26],\"depth\":[3,2,1,3,2,1,2,1,2,1,2,1,2,1,2,1,2,1,3,2,1,3,2,1,3,2,1,3,2,1,3,2,1,3,2,1,4,3,2,1,4,3,2,1,4,3,2,1,4,3,2,1,4,3,2,1,4,3,2,1,3,2,1,3,2,1,3,2,1,3,2,1,3,2,1,3,2,1],\"label\":[\"Rprof\",\"profvis\",\".main\",\"Rprof\",\"profvis\",\".main\",\"pause\",\"f\",\"pause\",\"f\",\"pause\",\"f\",\"pause\",\"f\",\"pause\",\"f\",\"pause\",\"f\",\"pause\",\"g\",\"f\",\"pause\",\"g\",\"f\",\"pause\",\"g\",\"f\",\"pause\",\"g\",\"f\",\"pause\",\"g\",\"f\",\"pause\",\"g\",\"f\",\"pause\",\"h\",\"g\",\"f\",\"pause\",\"h\",\"g\",\"f\",\"pause\",\"h\",\"g\",\"f\",\"pause\",\"h\",\"g\",\"f\",\"pause\",\"h\",\"g\",\"f\",\"pause\",\"h\",\"g\",\"f\",\"pause\",\"h\",\"f\",\"pause\",\"h\",\"f\",\"pause\",\"h\",\"f\",\"pause\",\"h\",\"f\",\"pause\",\"h\",\"f\",\"pause\",\"h\",\"f\"],\"filenum\":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],\"linenum\":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],\"memalloc\":[10.27104949951172,10.27104949951172,10.27104949951172,10.27104949951172,10.27104949951172,10.27104949951172,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266,10.27982330322266],\"meminc\":[0,0,0,0,0,0,0.0087738037109375,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\"filename\":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]},\"interval\":10,\"files\":[],\"prof_output\":\"C:\\\\Users\\\\jonth\\\\AppData\\\\Local\\\\Temp\\\\RtmpQ1FshQ\\\\file5e1c3b12124c.prof\",\"highlight\":{\"output\":[\"^output\\\\$\"],\"gc\":[\"^<GC>$\"],\"stacktrace\":[\"^\\\\.\\\\.stacktraceo(n|ff)\\\\.\\\\.$\"]},\"split\":\"h\"}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n## Mini-case study: poor practice of copy-on-modify\n\nProfiling a loop that modifies an existing variable:\nmost of the time is spent in \n[garbage collection](https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)) \n(i.e. releasing and reclaiming memory that is no longer needed).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprofvis::profvis({\n  x <- integer()\nfor (i in 1:1e4) {\n  x <- c(x, i)\n}\n})\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"profvis html-widget html-fill-item\" id=\"htmlwidget-1de94a4a962dccdcb02c\" style=\"width:100%;height:600px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-1de94a4a962dccdcb02c\">{\"x\":{\"message\":{\"prof\":{\"time\":[1,1,2,2,3,3,4,4,4,5,5,6,6],\"depth\":[2,1,2,1,2,1,3,2,1,2,1,2,1],\"label\":[\"c\",\".main\",\"c\",\".main\",\"c\",\".main\",\"<GC>\",\"c\",\".main\",\"c\",\".main\",\"c\",\".main\"],\"filenum\":[null,null,null,null,null,null,null,null,null,null,null,null,null],\"linenum\":[null,null,null,null,null,null,null,null,null,null,null,null,null],\"memalloc\":[33.37953186035156,33.37953186035156,62.49421691894531,62.49421691894531,41.49342346191406,41.49342346191406,18.11503601074219,18.11503601074219,18.11503601074219,56.19474029541016,56.19474029541016,34.97829437255859,34.97829437255859],\"meminc\":[0,0,29.11468505859375,0,-21.00079345703125,0,-23.37838745117188,0,0,38.07970428466797,0,-21.21644592285156,0],\"filename\":[null,null,null,null,null,null,null,null,null,null,null,null,null]},\"interval\":10,\"files\":[],\"prof_output\":\"C:\\\\Users\\\\jonth\\\\AppData\\\\Local\\\\Temp\\\\RtmpQ1FshQ\\\\file5e1c7f2bb86.prof\",\"highlight\":{\"output\":[\"^output\\\\$\"],\"gc\":[\"^<GC>$\"],\"stacktrace\":[\"^\\\\.\\\\.stacktraceo(n|ff)\\\\.\\\\.$\"]},\"split\":\"h\"}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\nYou can figure out what is the source of the problem by looking at the memory column. \nIn this case, **copy-on-modify** acts in each iteration of the loop creating another copy of `x`.\n\n- All the time is being spent in the concatenation operation.\n- Nearly the same amount of memory is being asked for and is being released.\n\n## Limitations\n\n- Profiling does not extend to C code.\n    * C code can be profiled with its own tools in C IDEs.\n- Anonymous functions do not show up properly.\n- Lazy evaluation of function arguments makes things complicated.\n    * Are things evaluated inside another function, and whose line is it anyway?\n\n\n### Exercise\n\nWhere is the time being spent in this function?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprofvis::profvis({\n  f <- function(n = 1e5) {\n  x <- rep(1, n)\n  rm(x)\n}\n}, torture = 10)\n```\n:::\n\n\n    ?rm()\n    \n[Solution](https://advanced-r-solutions.rbind.io/measuring-performance.html)    \n    \n## Microbenchmarking\n\nIn software development, _microbenchmarking_ is understood as \nmeasuring time or other aspects of performance of a very small piece of code.\nYou expect the code to run microseconds, but you know that in your\nlarger project, you will run this thousands or millions of times.\nIt is particularly useful when you are considering different implementations\nof that very frequently repeated step, and want to maximize performance.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Credits: Google search-engine](images/23_microbenchmarking.jpeg){fig-align='center' width=159}\n:::\n:::\n\n\n## Microbenchmarking\n\n\n::: {.cell}\n\n```{.r .cell-code}\nx <- runif(100)\nuniroot_sqrt <- function(x) {\n  solution <- x\n  for(i in seq_along(x)) {\n    solution[i] <- uniroot( \n      f = function(z, a) { z*z - a }, \n      interval = c(0,1), \n      tol = 5 * .Machine$double.eps,\n      a = x[i]) |> \n      purrr::pluck('root')\n  }\n  solution\n}\n```\n:::\n\n\n## Microbenchmarking\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmb1 <- microbenchmark(\n  sqrt(x),\n  x ^ 0.5,\n  exp( 0.5 * log(x)),\n  uniroot_sqrt(x)\n)\nmb1\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Unit: nanoseconds\n#>               expr     min      lq    mean  median      uq      max neval\n#>            sqrt(x)     300     500    1116     700    1600     5600   100\n#>              x^0.5    2900    3300    4082    3700    4550    10700   100\n#>  exp(0.5 * log(x))    8500    9400   10477   10100   11250    19900   100\n#>    uniroot_sqrt(x) 2578200 3201350 3697142 3344050 3506400 26347800   100\n```\n\n\n:::\n:::\n\n\nThe underlying `data.frame()`-ish object is only `expr` and `time`.\nWhat you see above is the `summary()` method applied to it.\n(Output of plain `mb1` differs between rendering systems;\ninteractively it is passed through the `print()` method.)\n\n## Microbenchmarking\n\nMuch greater detail is provided by the `{bench}` package: `bench::mark()`.\n    \n    \n\n::: {.cell}\n\n```{.r .cell-code}\nlb <- bench::mark(\n  sqrt(x),\n  x ^ 0.5,\n  exp( 0.5 * log(x)),\n  uniroot_sqrt(x)\n)\nlb\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 4 × 6\n#>   expression             min   median `itr/sec` mem_alloc `gc/sec`\n#>   <bch:expr>        <bch:tm> <bch:tm>     <dbl> <bch:byt>    <dbl>\n#> 1 sqrt(x)              300ns    400ns  1772924.      848B      0  \n#> 2 x^0.5                2.9µs    3.3µs   300156.      848B      0  \n#> 3 exp(0.5 * log(x))    7.9µs    9.2µs   106807.      848B      0  \n#> 4 uniroot_sqrt(x)     2.51ms   3.35ms      289.      848B     30.8\n```\n\n\n:::\n:::\n\n\nAgain, what you see above is `summary(lb)`. \nTiming for each run is inside the S3 class components.\n(Output of plain `lb` differs between rendering systems;\ninteractively it is passed through the `print()` method.)\n\n## Microbenchmarking distributions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(lb)\n```\n\n::: {.cell-output-display}\n![](23_files/figure-revealjs/unnamed-chunk-9-1.png){width=960}\n:::\n:::\n\n\nResults are typically heavily skewed: some calculations\nmay have hit \"unfortunate\" moments with the system was busy\nwith something else. Pay more attention to medians rather than means.\nThe `uniroot`-based calculation was so slow that `bench::mark()`\ndecided to stop after a few hundred runs rather than the default\n10000 runs, so as to fit the total simulation budget of 0.5 sec.\n\n## Other considerations\n\n::: notes\nShould this go to the next chapter \"Performance\" instead maybe?\n:::\n\nThings that can/will affect performance,\nsome are hard to measure:\n\n- Scaling \n    * bubble sort: $O(n^2)$, actual sort: $O(n \\log n)$\n    * matrix inversion: $O(n^3)$ in linear algebra classes,\n      $O(n^{-2.3})$ with the best algorithms\n      \n- I/O bottlenecks\n\n  * CPU cache $\\approx$ 1000x faster than RAM which is \n    $\\approx$ 1000 faster than local HDD which is $\\approx$ \n    10--100 faster than network/cloud\n\n- Laziness and [prudence](https://duckplyr.tidyverse.org/articles/prudence.html):\nwhen things get evaluated and put into memory\n\n- Understand how parallel processing (`future`, `mirai`) passes objects between instances,\n  depend on each others' completions, and wait for one another otherwise\n\n## Resources\n\n- [profvis package](https://rstudio.github.io/profvis/)\n- [bench package](https://cran.r-project.org/web/packages/bench/bench.pdf)\n- [solutions](https://advanced-r-solutions.rbind.io/measuring-performance.html)\n",
    "supporting": [
      "23_files\\figure-revealjs"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/htmltools-fill-0.5.9/fill.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../site_libs/jquery-3.7.1/jquery.min.js\"></script>\n<script src=\"../site_libs/d3-3.5.6/d3.min.js\"></script>\n<link href=\"../site_libs/profvis-0.3.6.9000/profvis.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/profvis-0.3.6.9000/profvis.js\"></script>\n<script src=\"../site_libs/profvis-0.3.6.9000/scroll.js\"></script>\n<link href=\"../site_libs/highlight-11.10.0/textmate.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/highlight-11.10.0/highlight.min.js\"></script>\n<script src=\"../site_libs/profvis-binding-0.4.0/profvis.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}